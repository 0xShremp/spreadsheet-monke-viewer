<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spreadsheet Monke Viewer</title>
    <meta property="og:title" content="Spreadsheet Monke Viewer" />
    <meta
      property="og:description"
      content="Explore and view Spreadsheet Monkes"
    />
    <meta
      property="og:image"
      content="https://spreadshet-monkes.netlify.app/spreadsheet-monkes-logo.png"
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://spreadshet-monkes.netlify.app/" />
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <style>
      body {
        position: relative;
        background: #000;
        background-image: url(assets/wallpaper-03.jpg);
        background-position: center;
        min-height: calc(100vh);
        margin: 0;
        padding: 0;
      }
      iframe {
        display: block;
        width: 300px;
        height: 300px;
        background: #fff;
      }
      .monke-control-group {
        display: flex;
      }
      .window {
        position: absolute;
      }

      label,
      input,
      select {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <!-- Loading Window -->
    <div class="window" id="loading-window" style="width: 320px">
      <div class="title-bar">
        <div class="title-bar-text">Loading Monke Data</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize"></button>
          <button aria-label="Maximize"></button>
          <button aria-label="Close"></button>
        </div>
      </div>
      <div class="window-body">
        <div style="text-align: center; padding: 20px;">
          <div style="margin-bottom: 15px;">ü¶ß</div>
          <div style="margin-bottom: 10px;"><strong>Loading Spreadsheet Monkes...</strong></div>
          <div style="font-size: 12px; color: #666;">Please wait while we load 10,000 monkes</div>
          <div id="loading-progress" style="margin-top: 15px; font-size: 11px; color: #888;"></div>
        </div>
      </div>
    </div>

    <!-- Main Content Windows (hidden initially) -->
    <div class="window" id="finder-window" style="width: 320px; display: none;">
      <div class="title-bar">
        <div class="title-bar-text">Monke Finder</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize"></button>
          <button aria-label="Maximize"></button>
          <button aria-label="Close"></button>
        </div>
      </div>
      <div class="window-body">
        <div class="monke-control-group">
          <label for="monke-number">Search a Monke:</label>
          <input
            type="number"
            id="monke-number"
            min="1"
            max="10000"
            value="1"
          />
        </div>
        <div class="monke-control-group">
          <label for="monke-select">Pick a Monke:</label>
          <select id="monke-select"></select>
        </div>
        <div class="monke-control-group">
          <label for="ninja-select">Ninja Monkes:</label>
          <select id="ninja-select">
            <option value="">-- Select --</option>
          </select>
        </div>
        <div class="monke-control-group">
          <label for="error-select">Error Monkes:</label>
          <select id="error-select">
            <option value="">-- Select --</option>
          </select>
        </div>
        <div class="monke-control-group">
          <label for="utility-select">Utility Monkes:</label>
          <select id="utility-select">
            <option value="">-- Select --</option>
          </select>
        </div>
      </div>
    </div>
    <div class="window" id="viewer-window" style="width: 320px; display: none;">
      <div class="title-bar">
        <div class="title-bar-text">Monke Viewer</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize"></button>
          <button aria-label="Maximize"></button>
          <button aria-label="Close"></button>
        </div>
      </div>
      <div class="window-body">
        <iframe id="monke-frame" src=""></iframe>
      </div>
    </div>
    <div class="window" id="metadata-window" style="width: 320px; display: none;">
      <div class="title-bar">
        <div class="title-bar-text">Monke Metadata</div>
        <div class="title-bar-controls">
          <button aria-label="Minimize"></button>
          <button aria-label="Maximize"></button>
          <button aria-label="Close"></button>
        </div>
      </div>
      <div class="window-body" style="height: 145px">
        <div id="monke-meta"></div>
      </div>
    </div>
    <div id="bottom-spacer"></div>

    <script>
      // Dynamically generate the list of monkes
      const monkeList = [];
      for (let i = 1; i <= 10000; i++) {
        monkeList.push({
          label: `Spreadsheet Monkes #${i}`,
          idx: i,
        });
      }
      const select = document.getElementById("monke-select");
      const frame = document.getElementById("monke-frame");
      const numberInput = document.getElementById("monke-number");
      const metaDiv = document.getElementById("monke-meta");
      
      // Populate dropdown
      monkeList.forEach((monke, idx) => {
        const option = document.createElement("option");
        option.value = monke.idx;
        option.textContent = monke.label;
        option.dataset.idx = monke.idx;
        select.appendChild(option);
      });
      
      // Load all hashlist data once with progress tracking
      let allHashlistData = null;
      const loadingProgress = document.getElementById("loading-progress");
      
      function updateLoadingProgress(message) {
        if (loadingProgress) {
          loadingProgress.textContent = message;
        }
      }
      
      function showMainInterface() {
        // Hide loading window
        document.getElementById("loading-window").style.display = "none";
        
        // Show main windows
        document.getElementById("finder-window").style.display = "block";
        document.getElementById("viewer-window").style.display = "block";
        document.getElementById("metadata-window").style.display = "block";
        
        // Re-stack windows after showing them
        stackWindowsVerticallyCentered();
      }
      
      // Track loading start time for minimum display duration
      const loadingStartTime = Date.now();
      const MIN_LOADING_TIME = 2000; // 2 seconds in milliseconds
      
      function showMainInterfaceWithDelay() {
        const elapsedTime = Date.now() - loadingStartTime;
        const remainingTime = Math.max(0, MIN_LOADING_TIME - elapsedTime);
        
        if (remainingTime > 0) {
          updateLoadingProgress("Ready! Starting interface...");
          setTimeout(showMainInterface, remainingTime);
        } else {
          showMainInterface();
        }
      }
      
      updateLoadingProgress("Loading hashlist data...");
      fetch('./data/hashlist.json')
        .then((resp) => {
          if (!resp.ok) throw new Error("Hashlist data not found");
          updateLoadingProgress("Processing hashlist data...");
          return resp.json();
        })
        .then((data) => {
          allHashlistData = data;
          updateLoadingProgress("Generating special monke lists...");
          
          // Generate special monke lists from hashlist data
          ninjaMonkes = [];
          errorMonkes = [];
          utilityMonkes = [];
          
          data.forEach((monke, index) => {
            const monkeNumber = index + 1;
            if (monke.meta && monke.meta.attributes) {
              monke.meta.attributes.forEach(attr => {
                if (attr.trait_type === 'ninja' && attr.value === 'true') {
                  ninjaMonkes.push(monkeNumber);
                }
                if (attr.trait_type === 'error' && attr.value !== 'false') {
                  errorMonkes.push(monkeNumber);
                }
                if (attr.trait_type === 'utility' && attr.value === 'true') {
                  utilityMonkes.push(monkeNumber);
                }
              });
            }
          });
          
          updateLoadingProgress("Setting up interface...");
          
          // Populate special selects after data is loaded
          populateSpecialSelect("ninja-select", ninjaMonkes);
          populateSpecialSelect("error-select", errorMonkes);
          populateSpecialSelect("utility-select", utilityMonkes);
          
          // Show main interface with minimum loading time
          showMainInterfaceWithDelay();
          
          // Initialize with first monke after everything is loaded
          updateMonkeDisplay(1);
        })
        .catch((error) => {
          console.error("Failed to load data:", error);
          loadingProgress.innerHTML = "‚ùå Failed to load data. Please refresh the page.";
          loadingProgress.style.color = "#c00";
        });

      // Display monke data from hashlist
      function loadMonkeData(idx) {
        const metaDiv = document.getElementById("monke-meta");
        metaDiv.innerHTML = "Loading metadata...";
        
        if (!allHashlistData || !allHashlistData[idx - 1]) {
          metaDiv.innerHTML = "No data found for this Monke.";
          return;
        }
        
        const data = allHashlistData[idx - 1];
        let html = "";
        if (data.meta && data.meta.name) {
          html += `<p style="width:100%;text-align:center;"><strong>${data.meta.name}</strong></p>`;
        }
        html += '<div class="sunken-panel">';
        html +=
          '<table class="interactive" style="width:100%; border-collapse:collapse;">';
        html += "<thead><tr><th>Attribute</th><th>Value</th></tr></thead>";
        html += "<tbody>";
        if (data.meta && data.meta.attributes) {
          data.meta.attributes.forEach((attr) => {
            html += `<tr><td>${attr.trait_type}</td><td>${attr.value}</td></tr>`;
          });
        }
        html += "</tbody>";
        html += "</table>";
        html += "</div>";

        metaDiv.innerHTML = html;
      }
      
      // Sync logic
      function updateMonkeDisplay(idx) {
        // idx is 1-based
        if (idx < 1) idx = 1;
        if (idx > 10000) idx = 10000;
        select.selectedIndex = idx - 1;
        numberInput.value = idx;
        
        // Update iframe from hashlist data
        if (allHashlistData && allHashlistData[idx - 1] && allHashlistData[idx - 1].meta && allHashlistData[idx - 1].meta.high_res_img_url) {
          frame.src = allHashlistData[idx - 1].meta.high_res_img_url;
        } else {
          frame.src = "";
        }
        
        loadMonkeData(idx);
      }
      
      select.addEventListener("change", function () {
        const idx = parseInt(select.value, 10);
        updateMonkeDisplay(idx);
      });
      
      numberInput.addEventListener("input", function () {
        let idx = parseInt(numberInput.value, 10);
        if (isNaN(idx)) idx = 1;
        updateMonkeDisplay(idx);
      });
      
      // Special monke lists (will be loaded during initialization)
      let ninjaMonkes = [];
      let errorMonkes = [];
      let utilityMonkes = [];
      
      // Populate special selects
      function populateSpecialSelect(selectId, monkeList) {
        const select = document.getElementById(selectId);
        monkeList.forEach((num) => {
          const option = document.createElement("option");
          option.value = num;
          option.textContent = `Spreadsheet Monkes #${num}`;
          select.appendChild(option);
        });
      }
      
      // Handle special selects
      function handleSpecialSelect(selectId) {
        const select = document.getElementById(selectId);
        select.addEventListener("change", function () {
          if (select.value) {
            // Clear other special selects
            const otherSelects = ['ninja-select', 'error-select', 'utility-select'].filter(id => id !== selectId);
            otherSelects.forEach(otherId => {
              document.getElementById(otherId).value = '';
            });
            
            updateMonkeDisplay(Number(select.value));
          }
        });
      }
      
      handleSpecialSelect("ninja-select");
      handleSpecialSelect("error-select");
      handleSpecialSelect("utility-select");
    </script>
    <script>
      // Make all .window elements draggable by their .title-bar
      document.querySelectorAll(".window").forEach((win) => {
        const titleBar = win.querySelector(".title-bar");
        let isDragging = false,
          offsetX = 0,
          offsetY = 0;

        titleBar.style.cursor = "move";
        titleBar.addEventListener("mousedown", function (e) {
          isDragging = true;
          const left =
            parseInt(win.style.left, 10) || win.getBoundingClientRect().left;
          const top =
            parseInt(win.style.top, 10) || win.getBoundingClientRect().top;
          offsetX = e.clientX - left;
          offsetY = e.clientY - top;
          win.style.position = "absolute";
          win.style.zIndex = 1000;
          win.style.left = left + "px";
          win.style.top = top + "px";
          document.body.appendChild(win);
        });

        document.addEventListener("mousemove", function (e) {
          if (!isDragging) return;
          win.style.left = e.clientX - offsetX + "px";
          win.style.top = e.clientY - offsetY + "px";
        });

        document.addEventListener("mouseup", function () {
          isDragging = false;
        });
      });
    </script>
    <script>
      function stackWindowsVerticallyCentered() {
        const windows = Array.from(document.querySelectorAll(".window:not([style*='display: none'])"))
          .filter(win => win.id !== "loading-window");
        const windowHeights = windows.map((win) => win.offsetHeight);
        const spacing = 16;
        const numWindows = windows.length;
        const totalSpacing = spacing * (numWindows - 1);
        const topAndBottom = spacing * 2;
        const stackHeight =
          windowHeights.reduce((a, b) => a + b, 0) +
          totalSpacing +
          topAndBottom;
        document.getElementById("bottom-spacer").style.height =
          stackHeight + "px";

        // Start stacking at 16px from the top
        let currentTop = spacing;
        windows.forEach((win) => {
          win.style.left = `${Math.max(
            (window.innerWidth - win.offsetWidth) / 2,
            0
          )}px`;
          win.style.top = `${currentTop}px`;
          currentTop += win.offsetHeight + spacing;
        });
      }
      
      function centerLoadingWindow() {
        const loadingWindow = document.getElementById("loading-window");
        if (loadingWindow) {
          loadingWindow.style.left = `${Math.max(
            (window.innerWidth - loadingWindow.offsetWidth) / 2,
            0
          )}px`;
          loadingWindow.style.top = `${Math.max(
            (window.innerHeight - loadingWindow.offsetHeight) / 2,
            16
          )}px`;
        }
      }

      // Initialize on load
      window.addEventListener("DOMContentLoaded", function() {
        centerLoadingWindow();
      });
      
      // Handle resize
      window.addEventListener("resize", function() {
        if (document.getElementById("loading-window").style.display !== "none") {
          centerLoadingWindow();
        } else {
          stackWindowsVerticallyCentered();
        }
      });
    </script>
  </body>
</html>
